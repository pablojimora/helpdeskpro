{
    "sourceFile": "src/app/tickets/[id]/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765298677612,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765298677612,
            "name": "Commit-0",
            "content": "'use client';\nimport React, { useEffect, useState } from 'react';\nimport { useSession } from 'next-auth/react';\nimport { useRouter, useParams } from 'next/navigation';\nimport { ticketService, ITicket } from '@/app/services/ticketService';\nimport { commentService, IComment } from '@/app/services/commentService';\nimport { notification } from '@/helpers/notificaciones';\nimport Card from '@/app/components/Card';\nimport Badge from '@/app/components/Badge';\nimport Button from '@/app/components/Button';\n\nexport default function TicketDetailPage() {\n  const { data: session, status } = useSession();\n  const router = useRouter();\n  const params = useParams();\n  const ticketId = params?.id as string;\n\n  const [ticket, setTicket] = useState<ITicket | null>(null);\n  const [comments, setComments] = useState<IComment[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [newComment, setNewComment] = useState('');\n  const [submitting, setSubmitting] = useState(false);\n\n  useEffect(() => {\n    if (status === 'loading') return;\n    \n    if (!session) {\n      router.push('/login');\n      return;\n    }\n\n    if (ticketId) {\n      loadTicketAndComments();\n    }\n  }, [session, status, router, ticketId]);\n\n  const loadTicketAndComments = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      \n      const [ticketData, commentsData] = await Promise.all([\n        ticketService.getTicketById(ticketId),\n        commentService.getCommentsByTicket(ticketId),\n      ]);\n      \n      setTicket(ticketData);\n      setComments(commentsData);\n    } catch (err: any) {\n      setError(err.response?.data?.error || 'Error al cargar los datos');\n      notification('Error al cargar el ticket', 'error');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleAddComment = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!newComment.trim()) {\n      notification('El comentario no puede estar vacío', 'error');\n      return;\n    }\n\n    try {\n      setSubmitting(true);\n      const comment = await commentService.createComment({\n        ticketId,\n        message: newComment,\n      });\n      \n      setComments([...comments, comment]);\n      setNewComment('');\n      notification('Comentario agregado correctamente', 'success');\n    } catch (err: any) {\n      notification(err.response?.data?.error || 'Error al agregar comentario', 'error');\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  const formatDate = (date?: string) => {\n    if (!date) return 'N/A';\n    return new Date(date).toLocaleDateString('es-ES', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n  };\n\n  const getClientName = (clientId: ITicket['clientId']) => {\n    if (typeof clientId === 'object' && clientId) {\n      return clientId.name;\n    }\n    return 'Cliente desconocido';\n  };\n\n  const getAgentName = (agentId: ITicket['agentId']) => {\n    if (typeof agentId === 'object' && agentId) {\n      return agentId.name;\n    }\n    return 'No asignado';\n  };\n\n  const getStatusText = (status: string) => {\n    const statusMap: Record<string, string> = {\n      'open': 'Abierto',\n      'in-progress': 'En Progreso',\n      'resolved': 'Resuelto',\n      'closed': 'Cerrado',\n    };\n    return statusMap[status] || status;\n  };\n\n  const getPriorityText = (priority: string) => {\n    const priorityMap: Record<string, string> = {\n      'low': 'Baja',\n      'medium': 'Media',\n      'high': 'Alta',\n      'urgent': 'Urgente',\n    };\n    return priorityMap[priority] || priority;\n  };\n\n  if (status === 'loading' || loading) {\n    return (\n      <div className=\"flex justify-center items-center min-h-screen\">\n        <div className=\"text-xl\">Cargando...</div>\n      </div>\n    );\n  }\n\n  if (error || !ticket) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 p-6\">\n        <div className=\"max-w-4xl mx-auto\">\n          <Card>\n            <div className=\"text-center py-8\">\n              <p className=\"text-red-600 mb-4\">{error || 'Ticket no encontrado'}</p>\n              <Button onClick={() => router.back()} variant=\"secondary\">\n                Volver\n              </Button>\n            </div>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 p-6\">\n      <div className=\"max-w-4xl mx-auto\">\n        <div className=\"mb-6\">\n          <Button onClick={() => router.back()} variant=\"secondary\" size=\"sm\">\n            ← Volver\n          </Button>\n        </div>\n\n        {/* Información del Ticket */}\n        <Card className=\"mb-6\">\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-start\">\n              <h1 className=\"text-2xl font-bold text-gray-900\">{ticket.title}</h1>\n              <div className=\"flex gap-2\">\n                <Badge variant={ticket.status}>{getStatusText(ticket.status)}</Badge>\n                <Badge variant={ticket.priority}>{getPriorityText(ticket.priority)}</Badge>\n              </div>\n            </div>\n\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-semibold text-gray-700 mb-2\">Descripción:</h3>\n              <p className=\"text-gray-600 whitespace-pre-wrap\">{ticket.description}</p>\n            </div>\n\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-semibold text-gray-700 mb-3\">Información:</h3>\n              <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                <div>\n                  <span className=\"text-gray-500\">Cliente:</span>\n                  <p className=\"font-medium\">{getClientName(ticket.clientId)}</p>\n                </div>\n                <div>\n                  <span className=\"text-gray-500\">Agente:</span>\n                  <p className=\"font-medium\">{getAgentName(ticket.agentId)}</p>\n                </div>\n                <div>\n                  <span className=\"text-gray-500\">Creado:</span>\n                  <p className=\"font-medium\">{formatDate(ticket.createdAt)}</p>\n                </div>\n                <div>\n                  <span className=\"text-gray-500\">Actualizado:</span>\n                  <p className=\"font-medium\">{formatDate(ticket.updatedAt)}</p>\n                </div>\n                {ticket.closedAt && (\n                  <div>\n                    <span className=\"text-gray-500\">Cerrado:</span>\n                    <p className=\"font-medium\">{formatDate(ticket.closedAt)}</p>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </Card>\n\n        {/* Sección de Comentarios */}\n        <Card>\n          <h2 className=\"text-xl font-bold text-gray-900 mb-4\">\n            Comentarios ({comments.length})\n          </h2>\n\n          {/* Listado de Comentarios */}\n          <div className=\"space-y-4 mb-6\">\n            {comments.length === 0 ? (\n              <p className=\"text-gray-500 text-center py-4\">\n                No hay comentarios aún. ¡Sé el primero en comentar!\n              </p>\n            ) : (\n              comments.map((comment) => (\n                <div\n                  key={comment._id}\n                  className=\"border border-gray-200 rounded-lg p-4 bg-gray-50\"\n                >\n                  <div className=\"flex justify-between items-start mb-2\">\n                    <div>\n                      <span className=\"font-semibold text-gray-900\">\n                        {comment.author.name}\n                      </span>\n                      <Badge\n                        variant={comment.author.role === 'agent' ? 'in-progress' : 'open'}\n                        className=\"ml-2\"\n                      >\n                        {comment.author.role === 'agent' ? 'Agente' : 'Cliente'}\n                      </Badge>\n                    </div>\n                    <span className=\"text-sm text-gray-500\">\n                      {formatDate(comment.createdAt)}\n                    </span>\n                  </div>\n                  <p className=\"text-gray-700 whitespace-pre-wrap\">{comment.message}</p>\n                </div>\n              ))\n            )}\n          </div>\n\n          {/* Formulario para agregar comentario */}\n          <div className=\"border-t pt-4\">\n            <h3 className=\"font-semibold text-gray-700 mb-3\">Agregar Comentario</h3>\n            <form onSubmit={handleAddComment} className=\"space-y-3\">\n              <textarea\n                value={newComment}\n                onChange={(e) => setNewComment(e.target.value)}\n                placeholder=\"Escribe tu comentario aquí...\"\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                rows={4}\n                maxLength={2000}\n                disabled={submitting}\n              />\n              <div className=\"flex justify-between items-center\">\n                <span className=\"text-xs text-gray-500\">\n                  {newComment.length}/2000 caracteres\n                </span>\n                <Button\n                  type=\"submit\"\n                  variant=\"primary\"\n                  size=\"md\"\n                  disabled={submitting || !newComment.trim()}\n                >\n                  {submitting ? 'Enviando...' : 'Agregar Comentario'}\n                </Button>\n              </div>\n            </form>\n          </div>\n        </Card>\n      </div>\n    </div>\n  );\n}\n"
        }
    ]
}