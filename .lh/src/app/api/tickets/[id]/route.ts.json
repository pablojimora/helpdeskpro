{
    "sourceFile": "src/app/api/tickets/[id]/route.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765300016718,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765300016718,
            "name": "Commit-0",
            "content": "import { NextRequest, NextResponse } from \"next/server\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/app/lib/auth\";\nimport dbConnection from \"@/app/lib/dbconnection\";\nimport Ticket from \"@/app/models/ticket\";\nimport { sendTicketClosedEmail } from \"@/app/services/emailService\";\n\n// GET - Obtener un ticket por ID\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const session = await getServerSession(authOptions);\n\n    if (!session?.user) {\n      return NextResponse.json(\n        { error: \"No autenticado\" },\n        { status: 401 }\n      );\n    }\n\n    await dbConnection();\n\n    const { id } = await params;\n    const ticket = await Ticket.findById(id)\n      .populate(\"clientId\", \"name email\")\n      .populate(\"agentId\", \"name email\");\n\n    if (!ticket) {\n      return NextResponse.json(\n        { error: \"Ticket no encontrado\" },\n        { status: 404 }\n      );\n    }\n\n    const userRole = (session.user as any).role;\n    const userId = (session.user as any).id;\n\n    // Verificar permisos: cliente solo puede ver sus propios tickets\n    if (userRole === \"client\" && ticket.clientId._id.toString() !== userId) {\n      return NextResponse.json(\n        { error: \"No autorizado para ver este ticket\" },\n        { status: 403 }\n      );\n    }\n\n    return NextResponse.json(\n      { ticket },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error(\"Error al obtener ticket:\", error);\n    return NextResponse.json(\n      { error: \"Error al obtener el ticket\" },\n      { status: 500 }\n    );\n  }\n}\n\n// PUT - Actualizar un ticket\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const session = await getServerSession(authOptions);\n\n    if (!session?.user) {\n      return NextResponse.json(\n        { error: \"No autenticado\" },\n        { status: 401 }\n      );\n    }\n\n    const body = await request.json();\n    const { title, description, status, priority, agentId } = body;\n\n    await dbConnection();\n\n    const { id } = await params;\n    const ticket = await Ticket.findById(id);\n\n    if (!ticket) {\n      return NextResponse.json(\n        { error: \"Ticket no encontrado\" },\n        { status: 404 }\n      );\n    }\n\n    const userRole = (session.user as any).role;\n    const userId = (session.user as any).id;\n\n    // Cliente solo puede editar título y descripción de sus propios tickets\n    if (userRole === \"client\") {\n      if (ticket.clientId.toString() !== userId) {\n        return NextResponse.json(\n          { error: \"No autorizado para editar este ticket\" },\n          { status: 403 }\n        );\n      }\n\n      // Cliente solo puede modificar título y descripción\n      if (title) ticket.title = title;\n      if (description) ticket.description = description;\n    }\n    // Agente puede modificar todos los campos\n    else if (userRole === \"agent\") {\n      const wasClosing = status === \"closed\" && ticket.status !== \"closed\";\n      \n      if (title) ticket.title = title;\n      if (description) ticket.description = description;\n      if (status) {\n        ticket.status = status;\n        // Si se cierra el ticket, marcar fecha de cierre\n        if (status === \"closed\" && !ticket.closedAt) {\n          ticket.closedAt = new Date();\n        }\n      }\n      if (priority) ticket.priority = priority;\n      if (agentId !== undefined) ticket.agentId = agentId || null;\n\n      await ticket.save();\n      await ticket.populate(\"clientId\", \"name email\");\n      await ticket.populate(\"agentId\", \"name email\");\n\n      // Enviar email al cliente si se cerró el ticket\n      if (wasClosing) {\n        try {\n          const clientData = ticket.clientId as any;\n          await sendTicketClosedEmail({\n            clientEmail: clientData.email,\n            clientName: clientData.name,\n            ticketId: ticket._id.toString(),\n            ticketTitle: ticket.title,\n            closedAt: ticket.closedAt!,\n          });\n        } catch (emailError) {\n          console.error('Error enviando email de cierre:', emailError);\n          // No fallar el request si el email falla\n        }\n      }\n    } else {\n      return NextResponse.json(\n        { error: \"Rol no autorizado\" },\n        { status: 403 }\n      );\n    }\n\n    // Populate solo si no es agente (ya se hizo arriba para agente)\n    if (userRole === \"client\") {\n      await ticket.save();\n      await ticket.populate(\"clientId\", \"name email\");\n      await ticket.populate(\"agentId\", \"name email\");\n    }\n\n    return NextResponse.json(\n      {\n        message: \"Ticket actualizado exitosamente\",\n        ticket,\n      },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error(\"Error al actualizar ticket:\", error);\n\n    if (error.name === \"ValidationError\") {\n      const messages = Object.values(error.errors).map((err: any) => err.message);\n      return NextResponse.json(\n        { error: messages.join(\", \") },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Error al actualizar el ticket\" },\n      { status: 500 }\n    );\n  }\n}\n\n// DELETE - Eliminar un ticket\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const session = await getServerSession(authOptions);\n\n    if (!session?.user) {\n      return NextResponse.json(\n        { error: \"No autenticado\" },\n        { status: 401 }\n      );\n    }\n\n    await dbConnection();\n\n    const { id } = await params;\n    const ticket = await Ticket.findById(id);\n\n    if (!ticket) {\n      return NextResponse.json(\n        { error: \"Ticket no encontrado\" },\n        { status: 404 }\n      );\n    }\n\n    const userRole = (session.user as any).role;\n    const userId = (session.user as any).id;\n\n    // Solo el cliente propietario o un agente pueden eliminar\n    if (userRole === \"client\" && ticket.clientId.toString() !== userId) {\n      return NextResponse.json(\n        { error: \"No autorizado para eliminar este ticket\" },\n        { status: 403 }\n      );\n    }\n\n    await Ticket.findByIdAndDelete(id);\n\n    return NextResponse.json(\n      { message: \"Ticket eliminado exitosamente\" },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error(\"Error al eliminar ticket:\", error);\n    return NextResponse.json(\n      { error: \"Error al eliminar el ticket\" },\n      { status: 500 }\n    );\n  }\n}\n"
        }
    ]
}