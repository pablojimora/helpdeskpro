{
    "sourceFile": "src/app/api/comments/route.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1765298677611,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765300016726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,8 +3,9 @@\n import { authOptions } from '@/app/lib/auth';\n import dbConnection from '@/app/lib/dbconnection';\n import Comment from '@/app/models/comment';\n import Ticket from '@/app/models/ticket';\n+import { sendAgentResponseEmail } from '@/app/services/emailService';\n \n // GET - Obtener comentarios de un ticket\n export async function GET(request: NextRequest) {\n   try {\n@@ -120,8 +121,30 @@\n \n     await comment.save();\n     await comment.populate('author', 'name email role');\n \n+    // Enviar email al cliente si quien comenta es un agente\n+    if (userRole === 'agent') {\n+      try {\n+        await ticket.populate('clientId', 'name email');\n+        await ticket.populate('title');\n+        const clientData = ticket.clientId as any;\n+        const authorData = comment.author as any;\n+        \n+        await sendAgentResponseEmail({\n+          clientEmail: clientData.email,\n+          clientName: clientData.name,\n+          ticketId: ticket._id.toString(),\n+          ticketTitle: ticket.title,\n+          agentName: authorData.name,\n+          commentMessage: comment.message,\n+        });\n+      } catch (emailError) {\n+        console.error('Error enviando email:', emailError);\n+        // No fallar el request si el email falla\n+      }\n+    }\n+\n     return NextResponse.json(\n       {\n         message: 'Comentario creado exitosamente',\n         comment,\n"
                }
            ],
            "date": 1765298677611,
            "name": "Commit-0",
            "content": "import { NextRequest, NextResponse } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/app/lib/auth';\nimport dbConnection from '@/app/lib/dbconnection';\nimport Comment from '@/app/models/comment';\nimport Ticket from '@/app/models/ticket';\n\n// GET - Obtener comentarios de un ticket\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getServerSession(authOptions);\n\n    if (!session?.user) {\n      return NextResponse.json(\n        { error: 'No autenticado' },\n        { status: 401 }\n      );\n    }\n\n    await dbConnection();\n\n    const { searchParams } = new URL(request.url);\n    const ticketId = searchParams.get('ticketId');\n\n    if (!ticketId) {\n      return NextResponse.json(\n        { error: 'El ticketId es obligatorio' },\n        { status: 400 }\n      );\n    }\n\n    // Verificar que el ticket existe\n    const ticket = await Ticket.findById(ticketId);\n    if (!ticket) {\n      return NextResponse.json(\n        { error: 'Ticket no encontrado' },\n        { status: 404 }\n      );\n    }\n\n    const userRole = (session.user as any).role;\n    const userId = (session.user as any).id;\n\n    // Verificar permisos: cliente solo puede ver comentarios de sus tickets\n    if (userRole === 'client' && ticket.clientId.toString() !== userId) {\n      return NextResponse.json(\n        { error: 'No autorizado para ver comentarios de este ticket' },\n        { status: 403 }\n      );\n    }\n\n    // Obtener comentarios del ticket\n    const comments = await Comment.find({ ticketId })\n      .populate('author', 'name email role')\n      .sort({ createdAt: 1 }); // Orden cronolÃ³gico\n\n    return NextResponse.json(\n      { comments },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('Error al obtener comentarios:', error);\n    return NextResponse.json(\n      { error: 'Error al obtener los comentarios' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST - Crear un nuevo comentario\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getServerSession(authOptions);\n\n    if (!session?.user) {\n      return NextResponse.json(\n        { error: 'No autenticado' },\n        { status: 401 }\n      );\n    }\n\n    const body = await request.json();\n    const { ticketId, message } = body;\n\n    if (!ticketId || !message) {\n      return NextResponse.json(\n        { error: 'ticketId y message son obligatorios' },\n        { status: 400 }\n      );\n    }\n\n    await dbConnection();\n\n    // Verificar que el ticket existe\n    const ticket = await Ticket.findById(ticketId);\n    if (!ticket) {\n      return NextResponse.json(\n        { error: 'Ticket no encontrado' },\n        { status: 404 }\n      );\n    }\n\n    const userRole = (session.user as any).role;\n    const userId = (session.user as any).id;\n\n    // Verificar permisos: cliente solo puede comentar en sus tickets\n    if (userRole === 'client' && ticket.clientId.toString() !== userId) {\n      return NextResponse.json(\n        { error: 'No autorizado para comentar en este ticket' },\n        { status: 403 }\n      );\n    }\n\n    // Crear el comentario\n    const comment = new Comment({\n      ticketId,\n      author: userId,\n      message,\n    });\n\n    await comment.save();\n    await comment.populate('author', 'name email role');\n\n    return NextResponse.json(\n      {\n        message: 'Comentario creado exitosamente',\n        comment,\n      },\n      { status: 201 }\n    );\n  } catch (error: any) {\n    console.error('Error al crear comentario:', error);\n\n    if (error.name === 'ValidationError') {\n      const messages = Object.values(error.errors).map((err: any) => err.message);\n      return NextResponse.json(\n        { error: messages.join(', ') },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: 'Error al crear el comentario' },\n      { status: 500 }\n    );\n  }\n}\n"
        }
    ]
}