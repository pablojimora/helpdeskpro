{
    "sourceFile": "src/app/dashClient/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765298677611,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765298677611,
            "name": "Commit-0",
            "content": "'use client';\nimport React, { useEffect, useState } from 'react';\nimport { useSession } from 'next-auth/react';\nimport { useRouter } from 'next/navigation';\nimport { ticketService, ITicket, CreateTicketData } from '../services/ticketService';\nimport Card from '../components/Card';\nimport Badge from '../components/Badge';\nimport Button from '../components/Button';\n\nexport default function DashClient() {\n  const { data: session, status } = useSession();\n  const router = useRouter();\n  const [tickets, setTickets] = useState<ITicket[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState<string | null>(null);\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [selectedTicket, setSelectedTicket] = useState<ITicket | null>(null);\n  const [showDetailModal, setShowDetailModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [formData, setFormData] = useState<CreateTicketData>({\n    title: '',\n    description: '',\n    priority: 'medium',\n  });\n  const [editFormData, setEditFormData] = useState({\n    title: '',\n    description: '',\n  });\n  const [formErrors, setFormErrors] = useState({\n    title: '',\n    description: '',\n  });\n\n  useEffect(() => {\n    if (status === 'loading') return;\n    \n    if (!session) {\n      router.push('/login');\n      return;\n    }\n\n    if (session.user?.role !== 'client') {\n      router.push('/dashAgent');\n      return;\n    }\n\n    loadTickets();\n  }, [session, status, router]);\n\n  const loadTickets = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      const data = await ticketService.getTickets();\n      setTickets(data);\n    } catch (err) {\n      setError('Error al cargar los tickets. Por favor, intenta de nuevo.');\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const validateForm = (): boolean => {\n    const errors = { title: '', description: '' };\n    let isValid = true;\n\n    if (!formData.title.trim()) {\n      errors.title = 'El título es obligatorio';\n      isValid = false;\n    } else if (formData.title.length < 3) {\n      errors.title = 'El título debe tener al menos 3 caracteres';\n      isValid = false;\n    } else if (formData.title.length > 200) {\n      errors.title = 'El título no puede exceder 200 caracteres';\n      isValid = false;\n    }\n\n    if (!formData.description.trim()) {\n      errors.description = 'La descripción es obligatoria';\n      isValid = false;\n    } else if (formData.description.length < 10) {\n      errors.description = 'La descripción debe tener al menos 10 caracteres';\n      isValid = false;\n    } else if (formData.description.length > 2000) {\n      errors.description = 'La descripción no puede exceder 2000 caracteres';\n      isValid = false;\n    }\n\n    setFormErrors(errors);\n    return isValid;\n  };\n\n  const validateEditForm = (): boolean => {\n    const errors = { title: '', description: '' };\n    let isValid = true;\n\n    if (!editFormData.title.trim()) {\n      errors.title = 'El título es obligatorio';\n      isValid = false;\n    } else if (editFormData.title.length < 3) {\n      errors.title = 'El título debe tener al menos 3 caracteres';\n      isValid = false;\n    } else if (editFormData.title.length > 200) {\n      errors.title = 'El título no puede exceder 200 caracteres';\n      isValid = false;\n    }\n\n    if (!editFormData.description.trim()) {\n      errors.description = 'La descripción es obligatoria';\n      isValid = false;\n    } else if (editFormData.description.length < 10) {\n      errors.description = 'La descripción debe tener al menos 10 caracteres';\n      isValid = false;\n    } else if (editFormData.description.length > 2000) {\n      errors.description = 'La descripción no puede exceder 2000 caracteres';\n      isValid = false;\n    }\n\n    setFormErrors(errors);\n    return isValid;\n  };\n\n  const handleCreateTicket = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!validateForm()) {\n      return;\n    }\n\n    try {\n      setError(null);\n      setSuccess(null);\n      await ticketService.createTicket(formData);\n      setSuccess('Ticket creado correctamente');\n      setShowCreateModal(false);\n      setFormData({ title: '', description: '', priority: 'medium' });\n      setFormErrors({ title: '', description: '' });\n      loadTickets();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Error al crear el ticket');\n      console.error(err);\n    }\n  };\n\n  const handleViewDetail = (ticket: ITicket) => {\n    router.push(`/tickets/${ticket._id}`);\n  };\n\n  const handleOpenEditModal = (ticket: ITicket) => {\n    setSelectedTicket(ticket);\n    setEditFormData({\n      title: ticket.title,\n      description: ticket.description,\n    });\n    setFormErrors({ title: '', description: '' });\n    setShowEditModal(true);\n  };\n\n  const handleEditTicket = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!validateEditForm() || !selectedTicket?._id) {\n      return;\n    }\n\n    try {\n      setError(null);\n      setSuccess(null);\n      await ticketService.updateTicket(selectedTicket._id, {\n        title: editFormData.title,\n        description: editFormData.description,\n      });\n      setSuccess('Ticket actualizado correctamente');\n      setShowEditModal(false);\n      setSelectedTicket(null);\n      setEditFormData({ title: '', description: '' });\n      setFormErrors({ title: '', description: '' });\n      loadTickets();\n    } catch (err: any) {\n      setError(err.response?.data?.message || 'Error al actualizar el ticket');\n      console.error(err);\n    }\n  };\n\n  const formatDate = (date?: string) => {\n    if (!date) return 'N/A';\n    return new Date(date).toLocaleDateString('es-ES', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n  };\n\n  const getAgentName = (agentId: ITicket['agentId']) => {\n    if (typeof agentId === 'object' && agentId) {\n      return agentId.name;\n    }\n    return 'No asignado';\n  };\n\n  const getStatusText = (status: string) => {\n    const statusMap: Record<string, string> = {\n      'open': 'Abierto',\n      'in-progress': 'En Progreso',\n      'resolved': 'Resuelto',\n      'closed': 'Cerrado',\n    };\n    return statusMap[status] || status;\n  };\n\n  const getPriorityText = (priority: string) => {\n    const priorityMap: Record<string, string> = {\n      'low': 'Baja',\n      'medium': 'Media',\n      'high': 'Alta',\n      'urgent': 'Urgente',\n    };\n    return priorityMap[priority] || priority;\n  };\n\n  if (status === 'loading' || loading) {\n    return (\n      <div className=\"flex justify-center items-center min-h-screen\">\n        <div className=\"text-xl\">Cargando...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 p-6\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"mb-8 flex justify-between items-center\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\n              Mis Tickets de Soporte\n            </h1>\n            <p className=\"text-gray-600\">\n              Bienvenido, {session?.user?.name || 'Cliente'}\n            </p>\n          </div>\n          <Button\n            variant=\"primary\"\n            size=\"lg\"\n            onClick={() => setShowCreateModal(true)}\n          >\n            + Crear Nuevo Ticket\n          </Button>\n        </div>\n\n        {error && (\n          <div className=\"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded\">\n            {error}\n          </div>\n        )}\n\n        {success && (\n          <div className=\"mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded\">\n            {success}\n          </div>\n        )}\n\n        {/* Listado de Tickets */}\n        <div className=\"mb-6\">\n          <h2 className=\"text-2xl font-semibold mb-4\">\n            Mis Tickets ({tickets.length})\n          </h2>\n          {tickets.length === 0 ? (\n            <Card>\n              <div className=\"text-center py-8\">\n                <p className=\"text-gray-500 mb-4\">\n                  No tienes tickets creados aún\n                </p>\n                <Button\n                  variant=\"primary\"\n                  size=\"md\"\n                  onClick={() => setShowCreateModal(true)}\n                >\n                  Crear mi primer ticket\n                </Button>\n              </div>\n            </Card>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {tickets.map((ticket) => (\n                <Card key={ticket._id}>\n                  <div className=\"flex flex-col h-full\">\n                    <div className=\"flex justify-between items-start mb-3\">\n                      <h3 className=\"text-lg font-semibold text-gray-900 flex-1 pr-2\">\n                        {ticket.title}\n                      </h3>\n                      <Badge variant={ticket.status}>\n                        {getStatusText(ticket.status)}\n                      </Badge>\n                    </div>\n                    \n                    <p className=\"text-sm text-gray-600 mb-3 line-clamp-3\">\n                      {ticket.description}\n                    </p>\n                    \n                    <div className=\"space-y-2 mb-4\">\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-gray-500\">Prioridad:</span>\n                        <Badge variant={ticket.priority}>\n                          {getPriorityText(ticket.priority)}\n                        </Badge>\n                      </div>\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-gray-500\">Agente asignado:</span>\n                        <span className=\"font-medium text-gray-700\">\n                          {getAgentName(ticket.agentId)}\n                        </span>\n                      </div>\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-gray-500\">Creado:</span>\n                        <span className=\"text-gray-700\">\n                          {formatDate(ticket.createdAt)}\n                        </span>\n                      </div>\n                      {ticket.closedAt && (\n                        <div className=\"flex items-center justify-between text-sm\">\n                          <span className=\"text-gray-500\">Cerrado:</span>\n                          <span className=\"text-gray-700\">\n                            {formatDate(ticket.closedAt)}\n                          </span>\n                        </div>\n                      )}\n                    </div>\n                    \n                    <div className=\"mt-auto\">\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"secondary\"\n                          size=\"sm\"\n                          onClick={() => handleOpenEditModal(ticket)}\n                          className=\"flex-1\"\n                        >\n                          Editar\n                        </Button>\n                        <Button\n                          variant=\"primary\"\n                          size=\"sm\"\n                          onClick={() => handleViewDetail(ticket)}\n                          className=\"flex-1\"\n                        >\n                          Ver Detalle\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                </Card>\n              ))}\n            </div>\n          )}\n        </div>\n\n        {/* Modal de Creación */}\n        {showCreateModal && (\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n            <div className=\"bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto\">\n              <h2 className=\"text-2xl font-bold mb-4\">Crear Nuevo Ticket</h2>\n              \n              <form onSubmit={handleCreateTicket} className=\"space-y-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Título del Ticket <span className=\"text-red-500\">*</span>\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.title}\n                    onChange={(e) => {\n                      setFormData({ ...formData, title: e.target.value });\n                      setFormErrors({ ...formErrors, title: '' });\n                    }}\n                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${\n                      formErrors.title\n                        ? 'border-red-500 focus:ring-red-500'\n                        : 'border-gray-300 focus:ring-blue-500'\n                    }`}\n                    placeholder=\"Ej: Problema con el inicio de sesión\"\n                    maxLength={200}\n                  />\n                  {formErrors.title && (\n                    <p className=\"text-red-500 text-sm mt-1\">{formErrors.title}</p>\n                  )}\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    {formData.title.length}/200 caracteres\n                  </p>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Descripción del Problema <span className=\"text-red-500\">*</span>\n                  </label>\n                  <textarea\n                    value={formData.description}\n                    onChange={(e) => {\n                      setFormData({ ...formData, description: e.target.value });\n                      setFormErrors({ ...formErrors, description: '' });\n                    }}\n                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${\n                      formErrors.description\n                        ? 'border-red-500 focus:ring-red-500'\n                        : 'border-gray-300 focus:ring-blue-500'\n                    }`}\n                    placeholder=\"Describe detalladamente tu problema o solicitud...\"\n                    rows={6}\n                    maxLength={2000}\n                  />\n                  {formErrors.description && (\n                    <p className=\"text-red-500 text-sm mt-1\">{formErrors.description}</p>\n                  )}\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    {formData.description.length}/2000 caracteres\n                  </p>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Prioridad\n                  </label>\n                  <select\n                    value={formData.priority}\n                    onChange={(e) => setFormData({ ...formData, priority: e.target.value as any })}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  >\n                    <option value=\"low\">Baja</option>\n                    <option value=\"medium\">Media</option>\n                    <option value=\"high\">Alta</option>\n                    <option value=\"urgent\">Urgente</option>\n                  </select>\n                </div>\n\n                <div className=\"flex gap-3 mt-6\">\n                  <Button\n                    type=\"submit\"\n                    variant=\"primary\"\n                    size=\"md\"\n                    className=\"flex-1\"\n                  >\n                    Crear Ticket\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"secondary\"\n                    size=\"md\"\n                    onClick={() => {\n                      setShowCreateModal(false);\n                      setFormData({ title: '', description: '', priority: 'medium' });\n                      setFormErrors({ title: '', description: '' });\n                    }}\n                    className=\"flex-1\"\n                  >\n                    Cancelar\n                  </Button>\n                </div>\n              </form>\n            </div>\n          </div>\n        )}\n\n        {/* Modal de Detalle */}\n        {showDetailModal && selectedTicket && (\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n            <div className=\"bg-white rounded-lg shadow-xl max-w-3xl w-full p-6 max-h-[90vh] overflow-y-auto\">\n              <div className=\"flex justify-between items-start mb-6\">\n                <h2 className=\"text-2xl font-bold\">Detalle del Ticket</h2>\n                <button\n                  onClick={() => setShowDetailModal(false)}\n                  className=\"text-gray-500 hover:text-gray-700 text-2xl\"\n                >\n                  ×\n                </button>\n              </div>\n              \n              <div className=\"space-y-4\">\n                <div>\n                  <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\n                    {selectedTicket.title}\n                  </h3>\n                  <div className=\"flex gap-2 mb-4\">\n                    <Badge variant={selectedTicket.status}>\n                      {getStatusText(selectedTicket.status)}\n                    </Badge>\n                    <Badge variant={selectedTicket.priority}>\n                      {getPriorityText(selectedTicket.priority)}\n                    </Badge>\n                  </div>\n                </div>\n\n                <div>\n                  <h4 className=\"font-semibold text-gray-700 mb-2\">Descripción:</h4>\n                  <p className=\"text-gray-600 whitespace-pre-wrap\">\n                    {selectedTicket.description}\n                  </p>\n                </div>\n\n                <div className=\"border-t pt-4\">\n                  <h4 className=\"font-semibold text-gray-700 mb-3\">Información del Ticket:</h4>\n                  <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                    <div>\n                      <span className=\"text-gray-500\">Estado:</span>\n                      <p className=\"font-medium\">{getStatusText(selectedTicket.status)}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-gray-500\">Prioridad:</span>\n                      <p className=\"font-medium\">{getPriorityText(selectedTicket.priority)}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-gray-500\">Agente Asignado:</span>\n                      <p className=\"font-medium\">{getAgentName(selectedTicket.agentId)}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-gray-500\">Creado:</span>\n                      <p className=\"font-medium\">{formatDate(selectedTicket.createdAt)}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-gray-500\">Última actualización:</span>\n                      <p className=\"font-medium\">{formatDate(selectedTicket.updatedAt)}</p>\n                    </div>\n                    {selectedTicket.closedAt && (\n                      <div>\n                        <span className=\"text-gray-500\">Fecha de cierre:</span>\n                        <p className=\"font-medium\">{formatDate(selectedTicket.closedAt)}</p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                <div className=\"border-t pt-4\">\n                  <p className=\"text-sm text-gray-500 italic\">\n                    Nota: Si necesitas agregar más información o hacer seguimiento, \n                    contacta con el agente asignado o espera su respuesta.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"mt-6 flex gap-3\">\n                <Button\n                  variant=\"primary\"\n                  size=\"md\"\n                  onClick={() => {\n                    setShowDetailModal(false);\n                    handleOpenEditModal(selectedTicket);\n                  }}\n                  className=\"flex-1\"\n                >\n                  Editar Ticket\n                </Button>\n                <Button\n                  variant=\"secondary\"\n                  size=\"md\"\n                  onClick={() => setShowDetailModal(false)}\n                  className=\"flex-1\"\n                >\n                  Cerrar\n                </Button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Modal de Edición */}\n        {showEditModal && selectedTicket && (\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n            <div className=\"bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto\">\n              <h2 className=\"text-2xl font-bold mb-4\">Editar Ticket</h2>\n              \n              <form onSubmit={handleEditTicket} className=\"space-y-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Título del Ticket <span className=\"text-red-500\">*</span>\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editFormData.title}\n                    onChange={(e) => {\n                      setEditFormData({ ...editFormData, title: e.target.value });\n                      setFormErrors({ ...formErrors, title: '' });\n                    }}\n                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${\n                      formErrors.title\n                        ? 'border-red-500 focus:ring-red-500'\n                        : 'border-gray-300 focus:ring-blue-500'\n                    }`}\n                    placeholder=\"Ej: Problema con el inicio de sesión\"\n                    maxLength={200}\n                  />\n                  {formErrors.title && (\n                    <p className=\"text-red-500 text-sm mt-1\">{formErrors.title}</p>\n                  )}\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    {editFormData.title.length}/200 caracteres\n                  </p>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Descripción del Problema <span className=\"text-red-500\">*</span>\n                  </label>\n                  <textarea\n                    value={editFormData.description}\n                    onChange={(e) => {\n                      setEditFormData({ ...editFormData, description: e.target.value });\n                      setFormErrors({ ...formErrors, description: '' });\n                    }}\n                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${\n                      formErrors.description\n                        ? 'border-red-500 focus:ring-red-500'\n                        : 'border-gray-300 focus:ring-blue-500'\n                    }`}\n                    placeholder=\"Describe detalladamente tu problema o solicitud...\"\n                    rows={6}\n                    maxLength={2000}\n                  />\n                  {formErrors.description && (\n                    <p className=\"text-red-500 text-sm mt-1\">{formErrors.description}</p>\n                  )}\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    {editFormData.description.length}/2000 caracteres\n                  </p>\n                </div>\n\n                <div className=\"bg-yellow-50 border border-yellow-200 rounded-md p-3\">\n                  <p className=\"text-sm text-yellow-800\">\n                    <strong>Nota:</strong> Como cliente, solo puedes editar el título y la descripción de tus tickets. \n                    El estado, prioridad y agente asignado son gestionados por el equipo de soporte.\n                  </p>\n                </div>\n\n                <div className=\"flex gap-3 mt-6\">\n                  <Button\n                    type=\"submit\"\n                    variant=\"primary\"\n                    size=\"md\"\n                    className=\"flex-1\"\n                  >\n                    Guardar Cambios\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"secondary\"\n                    size=\"md\"\n                    onClick={() => {\n                      setShowEditModal(false);\n                      setSelectedTicket(null);\n                      setEditFormData({ title: '', description: '' });\n                      setFormErrors({ title: '', description: '' });\n                    }}\n                    className=\"flex-1\"\n                  >\n                    Cancelar\n                  </Button>\n                </div>\n              </form>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n"
        }
    ]
}